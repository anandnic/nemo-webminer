var{chromium:w}=require("playwright"),g=require("fs"),f=require("xlsx");async function h({url:e,selectors:i,output:n="output.xlsx",format:o="file"}){if(!e)throw new Error("Missing url");let a=d(i),s=await w.launch(),t=await s.newPage();await t.goto(e,{waitUntil:"networkidle"});let r,c;return a?(r=await x(t,a),c=Object.keys(a)):(r=await y(t),c=Object.keys(r).sort()),await s.close(),E(r,c,o,n)}function d(e){if(e==null||typeof e=="string"&&e.trim()==="")return null;if(typeof e=="string"){let i={};return e.split(",").map(n=>n.trim()).filter(Boolean).forEach(n=>{let o=n.split(":").map(a=>a.trim());o.length>1?i[o[0]]=o[1]:i[n]=n}),i}if(typeof e=="object")return e;throw new Error("Invalid selectors format")}async function y(e){return e.evaluate(()=>{function i(s){if(!s)return"";let t=s.replace(/\s+/g," ").trim();try{let r=document.createElement("textarea");r.innerHTML=t,t=r.value}catch{}return t=t.replace(/\\([\\'"])/g,"$1"),t}let n=document.body.querySelectorAll("*"),o={},a=["script","style","noscript"];return n.forEach(s=>{let t=s.tagName.toLowerCase();if(a.includes(t))return;let r="";for(let c of s.childNodes)c.nodeType===Node.TEXT_NODE&&c.nodeValue.trim()&&(r+=i(c.nodeValue)+" ");r=r.trim(),r&&(o[t]||(o[t]=[]),o[t].push(r))}),o})}async function x(e,i){try{return await e.evaluate(n=>{function o(t){if(!t)return"";let r=t.replace(/\s+/g," ").trim();try{let c=document.createElement("textarea");c.innerHTML=r,r=c.value}catch{}return r=r.replace(/\\([\\'"])/g,"$1"),r}let a={},s=["script","style","noscript"];return Object.entries(n).forEach(([t,r])=>{let c;try{c=Array.from(document.querySelectorAll(r))}catch{throw new Error(`Invalid selector for column '${t}': '${r}'`)}a[t]=c.filter(l=>!s.includes(l.tagName.toLowerCase())).map(l=>{let u=o(l.innerText);if(l.tagName.toLowerCase()==="img"){let p=l.getAttribute("alt"),m=l.getAttribute("src");p&&p.trim()&&(u+=` [alt: ${o(p)}]`),m&&(u+=` [src: ${o(m)}]`)}return u}).filter(l=>l!=="")}),a},i)}catch(n){throw n}}function E(e,i,n,o){if(n==="json")return e;if(n==="file"){let a=b(e,i),s=T(a,i);return g.writeFileSync(o,s),o}else throw new Error(`Unsupported format: ${n}`)}function b(e,i){if(!i||i.length===0)return[];let n=0;i.forEach(a=>{e[a]&&e[a].length>n&&(n=e[a].length)});let o=[];for(let a=0;a<n;a++){let s={};i.forEach(t=>{s[t]=e[t]&&e[t][a]||""}),o.push(s)}return o}function T(e,i){let n=f.utils.book_new(),o=32760,a=e.map(r=>{let c={};return i.forEach(l=>{let u=r[l]||"";typeof u=="string"&&u.length>o&&(u=u.substring(0,o)+"... [truncated]"),c[l]=u}),c}),s=f.utils.json_to_sheet(a,{header:i});return f.utils.book_append_sheet(n,s,"Scraped Data"),f.write(n,{type:"buffer",bookType:"xlsx"})}module.exports={nemoMine:h};
